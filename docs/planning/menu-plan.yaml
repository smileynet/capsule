phases:
  - id: phase-1
    title: "Phase 1: Collapsible Tree Navigation"
    description: "Add expand/collapse state and directional navigation to browse mode"

    features:
      - id: feature-1.1
        title: "Feature 1.1: Collapsible tree with expand/collapse state"
        priority: 2
        user_story: "As a dashboard user, I want to expand and collapse epic/feature nodes so that I can focus on relevant parts of the hierarchy without visual clutter"
        acceptance_criteria:
          - "Nodes can be expanded to show children or collapsed to hide them"
          - "Expansion state persists during navigation and refresh"
          - "Visual indicators show expand state (▶ collapsed, ▼ expanded, • leaf)"
          - "Child count badge [N] shows number of open children"
          - "Default state: epics expanded, features collapsed"

        tasks:
          - title: "Add expansion state to tree nodes"
            priority: 1
            tracer: "Foundation - proves we can track which nodes are expanded"
            description: |
              - Add `expanded` bool field to treeNode struct
              - Add `defaultExpanded` bool to control initial state
              - Update buildTree to set default expansion (epics=true, features=false)
              - Add helper: isExpandable(node) - true for epic/feature with children
            deliverable: "internal/dashboard/tree.go with expansion state"
            tdd: true

          - title: "Filter tree rendering to only show expanded nodes"
            priority: 1
            depends_on: ["Add expansion state to tree nodes"]
            tracer: "Rendering - proves collapsed nodes hide their children"
            description: |
              - Update flattenTree to skip children of collapsed nodes
              - Preserve depth tracking for proper indentation
              - Update prefix generation for collapsed subtrees
            deliverable: "flattenTree respects expansion state"
            tdd: true

          - title: "Add expand/collapse indicators to tree view"
            priority: 2
            depends_on: ["Filter tree rendering to only show expanded nodes"]
            tracer: "Visual feedback - proves users can see expand state"
            description: |
              - Add indicator symbols: ▶ (collapsed), ▼ (expanded), • (leaf)
              - Add child count badge [N] for expandable nodes
              - Update tree rendering to show indicators before node title
              - Handle edge case: empty epic/feature shows [0]
            deliverable: "Tree view with expand indicators and badges"
            tdd: false

      - id: feature-1.2
        title: "Feature 1.2: Directional keyboard navigation (→←hl)"
        priority: 2
        user_story: "As a dashboard user, I want to use arrow keys to expand/collapse nodes so that I can navigate the hierarchy without accidentally launching work"
        acceptance_criteria:
          - "Right arrow (→) or 'l' expands collapsed node and moves cursor to first child"
          - "Left arrow (←) or 'h' collapses expanded node or moves to parent"
          - "Right arrow on leaf node is no-op"
          - "Left arrow on collapsed node moves cursor to parent"
          - "Navigation works consistently across all node types"

        tasks:
          - title: "Implement right arrow expand logic"
            priority: 1
            depends_on: ["Add expansion state to tree nodes"]
            tracer: "Expand action - proves right arrow expands and navigates"
            description: |
              - Add "right", "l" case to browse handleKey
              - If node is expandable and collapsed: expand it, move cursor to first child
              - If node is expandable and expanded: move cursor to first child
              - If node is leaf: no-op
              - Return updated browseState
            deliverable: "Right arrow expands nodes"
            tdd: true

          - title: "Implement left arrow collapse logic"
            priority: 1
            depends_on: ["Implement right arrow expand logic"]
            tracer: "Collapse action - proves left arrow collapses and navigates to parent"
            description: |
              - Add "left", "h" case to browse handleKey
              - If node is expanded: collapse it
              - If node is collapsed or leaf: find parent in flatNodes, move cursor to it
              - Handle edge case: root node has no parent (no-op)
              - Return updated browseState
            deliverable: "Left arrow collapses nodes and navigates to parent"
            tdd: true

          - title: "Update help text for new navigation keys"
            priority: 3
            depends_on: ["Implement left arrow collapse logic"]
            tracer: "Discoverability - proves users know about new keys"
            description: |
              - Update BrowseKeyMap to include →←hl bindings
              - Add help text: "→/l expand, ←/h collapse"
              - Update ShortHelp and FullHelp methods
              - Ensure help bar shows new keys
            deliverable: "Help text includes directional navigation"
            tdd: false

      - id: feature-1.3
        title: "Feature 1.3: Preserve expansion state across operations"
        priority: 3
        user_story: "As a dashboard user, I want expansion state to persist during refresh and navigation so that I don't lose my place in the hierarchy"
        acceptance_criteria:
          - "Expansion state preserved when refreshing bead list"
          - "Cursor position restored after refresh (snap to last selected ID)"
          - "Expansion state preserved when returning from pipeline/campaign"
          - "Expansion state cleared only on explicit user action (collapse all)"

        tasks:
          - title: "Store expansion state in browse model"
            priority: 2
            depends_on: ["Add expansion state to tree nodes"]
            tracer: "State persistence - proves we can remember expansion across rebuilds"
            description: |
              - Add expandedIDs map[string]bool to browseState
              - Update expand/collapse handlers to update expandedIDs
              - Update buildTree to read from expandedIDs when setting initial state
              - Handle case: bead no longer exists (remove from expandedIDs)
            deliverable: "browseState tracks expansion across tree rebuilds"
            tdd: true

          - title: "Restore expansion state on refresh"
            priority: 2
            depends_on: ["Store expansion state in browse model"]
            tracer: "Refresh preservation - proves state survives bead list reload"
            description: |
              - Update BeadListMsg handler to preserve expandedIDs
              - Rebuild tree with preserved expansion state
              - Restore cursor to lastDispatchedID if set
              - Test: refresh with mixed expanded/collapsed nodes
            deliverable: "Refresh preserves expansion and cursor"
            tdd: true

          - title: "Add collapse-all action (optional)"
            priority: 4
            depends_on: ["Store expansion state in browse model"]
            tracer: "Reset action - proves users can quickly collapse everything"
            description: |
              - Add 'c' key binding for collapse-all
              - Clear expandedIDs map
              - Rebuild tree with default expansion
              - Update help text
            deliverable: "Collapse-all key binding"
            tdd: false

  - id: phase-2
    title: "Phase 2: Enhanced Browse Experience"
    description: "Polish and edge cases for collapsible navigation"

    features:
      - id: feature-2.1
        title: "Feature 2.1: Smart cursor movement and edge cases"
        priority: 3
        user_story: "As a dashboard user, I want cursor movement to feel natural when expanding/collapsing nodes so that navigation is intuitive"
        acceptance_criteria:
          - "Expanding a node moves cursor to first child (if children exist)"
          - "Collapsing a node keeps cursor on the collapsed node"
          - "Left arrow on root node is no-op (no parent to navigate to)"
          - "Right arrow on empty epic/feature shows '(no open tasks)' message"
          - "Cursor never lands on invalid index after expand/collapse"

        tasks:
          - title: "Handle empty expandable nodes"
            priority: 2
            depends_on: ["Implement right arrow expand logic"]
            tracer: "Empty node handling - proves we handle epics/features with no open children"
            description: |
              - Detect when expandable node has zero open children
              - Show "(no open tasks)" in tree view when expanded
              - Right arrow on empty node: expand but don't move cursor
              - Update child count badge to show [0]
            deliverable: "Empty nodes display correctly"
            tdd: true

          - title: "Add cursor bounds checking"
            priority: 2
            depends_on: ["Implement left arrow collapse logic"]
            tracer: "Safety - proves cursor never goes out of bounds"
            description: |
              - Add bounds check after expand/collapse operations
              - Clamp cursor to valid range [0, len(flatNodes)-1]
              - Handle edge case: collapsing last visible node
              - Add test: collapse node that cursor is on
            deliverable: "Cursor always valid after operations"
            tdd: true

          - title: "Optimize tree rebuild performance"
            priority: 4
            depends_on: ["Store expansion state in browse model"]
            tracer: "Performance - proves large trees don't lag"
            description: |
              - Profile buildTree and flattenTree with 100+ nodes
              - Cache flattened tree until expansion state changes
              - Only rebuild on expand/collapse/refresh, not on cursor move
              - Benchmark: <10ms for 100 node tree
            deliverable: "Tree operations are fast"
            tdd: false
